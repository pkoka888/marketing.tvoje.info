---
# Deploy Node.js / PM2 Application
#
# Usage:
#   ansible-playbook -i inventory.yml playbooks/deploy-node.yml \
#     -e "target_server=s62 project_name=myapp deploy_path=/var/www/projects/myapp pm2_name=myapp app_port=4321"
#
# Required variables:
#   target_server  - Ansible host name (s60, s62)
#   project_name   - Human-readable project identifier
#   deploy_path    - Absolute path on target server
#   pm2_name       - PM2 process name
#   app_port       - Port the app listens on
---
- name: "Deploy Node.js app: {{ project_name }}"
  hosts: "{{ target_server }}"
  gather_facts: true
  become: false

  vars:
    backup_dir: "/tmp/deploy-backup-{{ project_name }}-{{ ansible_date_time.epoch }}"
    node_env: production

  pre_tasks:
    - name: "SAFETY: Block auto-deploy to s61"
      ansible.builtin.fail:
        msg: "ğŸ”´ BLOCKED: Cannot auto-deploy to s61 (gateway). Requires human approval."
      when: inventory_hostname == 's61'

    - name: "SAFETY: Verify deploy_path is within allowed paths"
      ansible.builtin.fail:
        msg: "ğŸ”´ BLOCKED: deploy_path '{{ deploy_path }}' is not within /var/www/"
      when: "'/var/www/' not in deploy_path"

    - name: "CHECK: Disk space"
      ansible.builtin.shell: df -h / | tail -1 | awk '{print $5}' | tr -d '%'
      register: disk_usage
      changed_when: false

    - name: "FAIL: Insufficient disk space"
      ansible.builtin.fail:
        msg: "ğŸ”´ Disk at {{ disk_usage.stdout }}%. Deployment blocked."
      when: disk_usage.stdout | int >= 90

    - name: "CHECK: Port availability"
      ansible.builtin.shell: "ss -tulpn | grep ':{{ app_port }}' | grep -v pm2 | grep -v node || echo 'PORT_OK'"
      register: port_check
      changed_when: false

    - name: "WARN: Port may have conflict"
      ansible.builtin.debug:
        msg: "âš ï¸ Port {{ app_port }} has existing listeners (may be the current app): {{ port_check.stdout }}"
      when: "'PORT_OK' not in port_check.stdout"

  tasks:
    - name: "Ensure deploy directory exists"
      ansible.builtin.file:
        path: "{{ deploy_path }}"
        state: directory
        mode: '0755'
      become: true

    - name: "Check for existing PM2 process"
      ansible.builtin.shell: pm2 describe {{ pm2_name }} 2>/dev/null && echo 'EXISTS' || echo 'NEW'
      register: pm2_exists
      changed_when: false

    - name: "Backup existing deployment"
      ansible.builtin.shell: |
        if [ -d "{{ deploy_path }}" ] && [ "$(ls -A {{ deploy_path }})" ]; then
          cp -r {{ deploy_path }} {{ backup_dir }}
          echo "Backup created: {{ backup_dir }}"
        else
          echo "No existing deployment to backup"
        fi
      register: backup_result
      changed_when: "'Backup created' in backup_result.stdout"

    - name: "Sync project files to server"
      ansible.posix.synchronize:
        src: "./"
        dest: "{{ deploy_path }}/"
        delete: false
        recursive: true
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=node_modules"
          - "--exclude=.env"
          - "--exclude=dist"

    - name: "Install npm dependencies (production)"
      ansible.builtin.shell: |
        cd {{ deploy_path }}
        npm ci --production 2>&1 || npm install --production 2>&1
      register: npm_install
      changed_when: "'added' in npm_install.stdout"

    - name: "Build project"
      ansible.builtin.shell: |
        cd {{ deploy_path }}
        NODE_ENV={{ node_env }} npm run build 2>&1
      register: npm_build
      changed_when: true

    - name: "Restart PM2 process (existing)"
      ansible.builtin.shell: pm2 restart {{ pm2_name }}
      when: "'EXISTS' in pm2_exists.stdout"
      register: pm2_restart

    - name: "Start PM2 process (new)"
      ansible.builtin.shell: |
        cd {{ deploy_path }}
        pm2 start npm --name {{ pm2_name }} -- start
        pm2 save
      when: "'NEW' in pm2_exists.stdout"
      register: pm2_start

    - name: "Wait for app to start"
      ansible.builtin.pause:
        seconds: 5

    - name: "Verify PM2 process is online"
      ansible.builtin.shell: pm2 describe {{ pm2_name }} | grep status | head -1
      register: pm2_final_status
      changed_when: false

  post_tasks:
    - name: "VERIFY: App responds on port {{ app_port }}"
      ansible.builtin.uri:
        url: "http://localhost:{{ app_port }}"
        status_code: [200, 301, 302]
        timeout: 10
      register: app_check
      failed_when: false

    - name: "SUMMARY: Deployment result"
      ansible.builtin.debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Node.js Deploy: {{ project_name }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Server:     {{ inventory_hostname }}
          Path:       {{ deploy_path }}
          PM2 name:   {{ pm2_name }}
          Port:       {{ app_port }}
          PM2 status: {{ pm2_final_status.stdout | default('unknown') }}
          App check:  {{ 'OK' if app_check.status | default(0) in [200,301,302] else 'FAILED' }}
          Backup:     {{ backup_result.stdout | default('none') }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
