name: Deploy LiteLLM

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

jobs:
  deploy-litellm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Deploy LiteLLM
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          LITELLM_MASTER_KEY: ${{ secrets.LITELLM_MASTER_KEY }}
        run: |
          chmod +x scripts/deploy-litellm.sh
          ./scripts/deploy-litellm.sh

      - name: Verify LiteLLM Health
        run: |
          sleep 8
          ssh -o StrictHostKeyChecking=no -p 20 ${{ secrets.VPS_USER }}@100.91.164.109 "curl -s http://localhost:4000/health | head -c 200"

      - name: Test Chat Completion
        run: |
          ssh -o StrictHostKeyChecking=no -p 20 ${{ secrets.VPS_USER }}@100.91.164.109 "curl -s -X POST http://localhost:4000/v1/chat/completions -H 'Content-Type: application/json' -d '{\"model\":\"groq/llama-3.3-70b-versatile\",\"messages\":[{\"role\":\"user\",\"content\":\"Hi\"}],\"max_tokens\":20}' | head -c 300"
