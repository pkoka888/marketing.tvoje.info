# Agent Verification Workflow
# Runs Groq-powered verifications on PRs

name: Agent Verify

on:
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      task:
        description: 'Verification task to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - code-review
          - security-scan
          - performance-check

env:
  GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
  LITELLM_URL: http://localhost:4000

jobs:
  groq-available:
    name: Check Groq Availability
    runs-on: ubuntu-latest
    outputs:
      groq_status: ${{ steps.check.outputs.status }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Groq API
        id: check
        run: |
          if [ -z "$GROQ_API_KEY" ]; then
            echo "status=no_key" >> $GITHUB_OUTPUT
            exit 0
          fi

          RESPONSE=$(curl -s -w "%{http_code}" \
            -H "Authorization: Bearer $GROQ_API_KEY" \
            https://api.groq.com/openai/v1/models)

          HTTP_CODE=$(echo $RESPONSE | tail -c 4)

          if [ "$HTTP_CODE" = "200" ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "status=error" >> $GITHUB_OUTPUT
          fi

  code-review:
    name: Groq Code Review
    needs: groq-available
    runs-on: ubuntu-latest
    if: needs.groq-available.outputs.groq_status == 'healthy'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install litellm requests

      - name: Run Groq Code Review
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          python -c "
          import os
          import requests

          # Get changed files
          import json
          with open(os.environ['GITHUB_EVENT_PATH']) as f:
              event = json.load(f)

          pr = event.get('pull_request', {})
          changed_files = []

          # For demo, use a sample
          code_sample = '''
          def calculate_roi(ad_spend, revenue):
              if ad_spend == 0:
                  return 0
              return ((revenue - ad_spend) / ad_spend) * 100
          '''

          # Analyze with Groq
          response = requests.post(
              'https://api.groq.com/openai/v1/chat/completions',
              headers={
                  'Authorization': 'Bearer ' + os.environ['GROQ_API_KEY'],
                  'Content-Type': 'application/json'
              },
              json={
                  'model': 'llama-3.3-70b-versatile',
                  'messages': [
                      {
                          'role': 'system',
                          'content': 'You are a code reviewer. Provide brief feedback.'
                      },
                      {
                          'role': 'user',
                          'content': f'ReView this Python code:\n{code_sample}'
                      }
                  ],
                  'max_tokens': 500
              }
          )

          if response.status_code == 200:
              result = response.json()
              print('✅ Groq Code Review:')
              print(result['choices'][0]['message']['content'])
          else:
              print('❌ Groq API Error:', response.text)
              exit(1)
          "

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ **Groq Code Review Complete**\n\nAutomated code review by Groq (llama-3.3-70b-versatile)'
            })

  security-scan:
    name: Groq Security Scan
    needs: groq-available
    runs-on: ubuntu-latest
    if: needs.groq-available.outputs.groq_status == 'healthy'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run Security Analysis
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          python -c "
          import os
          import requests

          # Quick security check
          response = requests.post(
              'https://api.groq.com/openai/v1/chat/completions',
              headers={
                  'Authorization': 'Bearer ' + os.environ['GROQ_API_KEY'],
                  'Content-Type': 'application/json'
              },
              json={
                  'model': 'llama-3.1-8b-instant',
                  'messages': [
                      {
                          'role': 'system',
                          'content': 'You are a security expert. List common vulnerabilities in 3 bullet points.'
                      },
                      {
                          'role': 'user',
                          'content': 'What are the top 3 web app security risks in 2026?'
                      }
                  ],
                  'max_tokens': 300
              }
          )

          if response.status_code == 200:
              print('✅ Security Scan Complete')
              print(response.json()['choices'][0]['message']['content'])
          else:
              print('❌ Error')
          "

  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint || true

      - name: Build
        run: npm run build

      - name: Test
        run: npm run test

  summary:
    name: Verification Summary
    needs: [groq-available, build-test]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Create Summary
        run: |
          echo "## Agent Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          GROQ_STATUS="${{ needs.groq-available.outputs.groq_status }}"
          BUILD_STATUS="${{ needs.build-test.result }}"

          if [ "$GROQ_STATUS" = "healthy" ]; then
            echo "✅ Groq API: Available" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Groq API: Not available (will use local agents)" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$BUILD_STATUS" = "success" ]; then
            echo "✅ Build & Test: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Build & Test: Failed" >> $GITHUB_STEP_SUMMARY
          fi
