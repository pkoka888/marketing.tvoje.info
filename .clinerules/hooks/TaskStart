#!/usr/bin/env python3
"""Cline TaskStart hook — injects audit context and writes to task audit log."""
import datetime
import json
import pathlib
import sys


def main():
    """Read task input, write audit log entry, return context modification."""
    try:
        input_data = json.load(sys.stdin)
    except EOFError:
        input_data = {}

    timestamp = datetime.datetime.now().isoformat()
    task_id = input_data.get("taskId", "unknown")

    # Audit log — absolute path relative to project root
    log_path = (
        pathlib.Path(__file__).parent.parent.parent
        / "plans"
        / "agent-shared"
        / "task_audits.log"
    )
    log_path.parent.mkdir(parents=True, exist_ok=True)
    with open(log_path, "a", encoding="utf-8") as f:
        f.write(f"[{timestamp}] Task {task_id} started\n")

    # Run Redis Verification
    redis_status = "⚠️ Redis check skipped"
    try:
        import subprocess

        script_path = (
            pathlib.Path(__file__).parent.parent.parent / "scripts" / "verify_redis.py"
        )
        if script_path.exists():
            result = subprocess.run(
                [sys.executable, str(script_path)],
                capture_output=True,
                text=True,
                timeout=3,
            )
            if result.returncode == 0:
                redis_status = "✅ Redis Verified (Auth + Namespace Isolated)"
            else:
                redis_status = (
                    f"❌ Redis FAILED: {result.stdout.strip() or result.stderr.strip()}"
                )
    except Exception as e:
        redis_status = f"❌ Redis Check Error: {e}"

    response = {
        "cancel": False,
        "contextModification": (
            f"### Task Audit Context\n"
            f"- Task ID: {task_id}\n"
            f"- Audit Timestamp: {timestamp}\n"
            f"- Environment: Unified Agentic Platform 2026\n"
            f"- Standard: BREVITY, NO ADJECTIVES, CLINE IS HIM.\n"
            f"- Canonical rules: .kilocode/rules/ | Governance: AGENTS.md\n"
            f"- Infrastructure: {redis_status}"
        ),
    }

    print(json.dumps(response))


if __name__ == "__main__":
    main()
