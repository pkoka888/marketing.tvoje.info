# Production Docker Compose Configuration
# For marketing.tvoje.info deployment on Server60 (S60)
# Updated: 2026-02-19 - Migrated from S62 to S60 for better SSH access
#
# S60 Specs:
# - Host: 89.203.173.196 (public) / 192.168.1.60 (internal)
# - SSH Port: 2260 (public reachable)
# - RAM: 94Gi (plenty available vs 3.8Gi on S62)
# - Docker: Installed and ready
# - Deploy Path: /opt/marketing-docker/
#
# Usage:
#   docker-compose -f docker-compose.prod.yml up -d
#   docker-compose -f docker-compose.prod.yml down

services:
  # Redis for MCP servers and caching
  redis:
    image: redis:7-alpine
    container_name: marketing-redis
    restart: unless-stopped
    # Internal network only - no external port exposure needed
    # Access via container network or through MCP Gateway
    volumes:
      - redis_data:/data
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --save 60 1000
      --requirepass "${REDIS_PASSWORD}"
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    networks:
      - marketing-network
    healthcheck:
      test: ['CMD', 'redis-cli', '-a', '${REDIS_PASSWORD}', 'ping']
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # MCP Gateway for managing MCP servers
  mcp-gateway:
    image: mcp/gateway:latest
    container_name: mcp-gateway
    restart: unless-stopped
    ports:
      - '3000:3000'
    environment:
      - NODE_ENV=production
      - GATEWAY_PORT=3000
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - PROJECT_NAME=${PROJECT_NAME}
      - JWT_SECRET=${JWT_SECRET}
    volumes:
      - ./docker/mcp/gateway-config.yml:/app/config.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - marketing-network
    depends_on:
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # Astro Build Service (run on-demand)
  # Usage: docker-compose -f docker-compose.prod.yml --profile build run --rm astro-build
  astro-build:
    build:
      context: .
      dockerfile: Dockerfile.build
      target: builder
    image: marketing-tvoje-info:build
    container_name: marketing-build
    environment:
      - NODE_ENV=production
      - PUBLIC_SITE_URL=${PUBLIC_SITE_URL}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
    volumes:
      - ./dist:/app/dist
      - build_cache:/app/node_modules/.cache
    networks:
      - marketing-network
    depends_on:
      - redis
    profiles:
      - build
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 512M
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # Optional: Caddy as lightweight alternative to Nginx
  # Uncomment if you want containerized web server instead of system Nginx
  # caddy:
  #   image: caddy:2-alpine
  #   container_name: marketing-caddy
  #   restart: unless-stopped
  #   ports:
  #     - "8080:80"
  #   volumes:
  #     - ./dist:/usr/share/caddy:ro
  #     - ./docker/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
  #     - caddy_data:/data
  #     - caddy_config:/config
  #   networks:
  #     - marketing-network
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 128M
  #       reservations:
  #         memory: 32M

  # Optional: Watchtower for automatic container updates
  watchtower:
    image: containrrr/watchtower
    container_name: marketing-watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=3600
      - WATCHTOWER_LABEL_ENABLE=true
    labels:
      - 'com.centurylinklabs.watchtower.enable=false'
    deploy:
      resources:
        limits:
          memory: 64M
    logging:
      driver: 'json-file'
      options:
        max-size: '5m'
        max-file: '3'

networks:
  marketing-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/16

volumes:
  redis_data:
    driver: local
  build_cache:
    driver: local
  # caddy_data:
  #   driver: local
  # caddy_config:
  #   driver: local
