---
import type { Language } from '../../i18n/translations';
import { getLangFromUrl, translations } from '../../i18n/translations';
import { getCollection } from 'astro:content';

interface Props {
  lang?: Language;
}

const { lang: propLang } = Astro.props;
const lang = propLang || getLangFromUrl(Astro.url);
const t = translations[lang];

// Get projects from content collections
const allProjects = await getCollection('projects');
interface ProjectStats {
  value: string;
  label: string;
}
interface Project {
  slug: string;
  title: string;
  description: string;
  image: string;
  tags: string[];
  category: string;
  stats: ProjectStats[];
}
const projects: Project[] = allProjects.map((project: { id: string; data: { title: string; description: string; image: string; tags: string[]; category: string; stats: ProjectStats[] } }) => ({
  slug: project.id.replace('.md', ''),
  title: project.data.title,
  description: project.data.description,
  image: project.data.image,
  tags: project.data.tags,
  category: project.data.category,
  stats: project.data.stats,
}));

const categories: { key: string; label: string }[] = [
  { key: 'all', label: t.projects.categories.all },
  { key: 'seo', label: t.projects.categories.seo },
  { key: 'ppc', label: t.projects.categories.ppc },
  { key: 'web', label: t.projects.categories.web },
  { key: 'creative', label: 'Creative' },
  { key: 'automation', label: 'Automation' },
  { key: 'ai', label: 'AI' },
];
---

<section id="projects" class="section bg-gray-50 dark:bg-dark-800">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Section Header -->
    <div class="text-center mb-16">
      <h2 class="section-title text-gray-900 dark:text-white">
        {t.projects.title}
      </h2>
      <p class="text-lg text-gray-600 dark:text-gray-300 max-w-2xl mx-auto mt-4">
        {t.projects.description}
      </p>
    </div>

    <!-- Category Filter -->
    <div class="flex flex-wrap justify-center gap-2 mb-12" role="group" aria-label="Project categories">
      {categories.map((category) => (
        <button
          type="button"
          class="px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 category-btn"
          data-category={category.key}
          aria-pressed="false"
        >
          {category.label}
        </button>
      ))}
    </div>

    <!-- Projects Grid -->
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8" id="projects-grid">
      {projects.map((project) => (
        <article
          class="glass-card project-card group"
          data-category={project.category}
          data-aos="fade-up"
        >
          <!-- Image -->
          <div class="relative overflow-hidden aspect-video">
            <img
              src={project.image}
              alt={project.title}
              loading="lazy"
              class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-500"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
          </div>

          <!-- Content -->
          <div class="p-6">
            <!-- Tags -->
            <div class="flex flex-wrap gap-2 mb-4">
              {project.tags.map((tag) => (
                <span class="px-2 py-1 text-xs font-medium rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300">
                  {tag}
                </span>
              ))}
            </div>

            <!-- Title -->
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2 group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors">
              {project.title}
            </h3>

            <!-- Description -->
            <p class="text-gray-600 dark:text-gray-300 text-sm mb-4 line-clamp-2">
              {project.description}
            </p>

            <!-- Stats -->
            <div class="flex gap-4 mb-4">
              {project.stats.map((stat) => (
                <div class="text-center">
                  <div class="text-lg font-bold text-primary-600 dark:text-primary-400">
                    {stat.value}
                  </div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">
                    {stat.label}
                  </div>
                </div>
              ))}
            </div>

            <!-- Link -->
            <a
              href={lang === 'cs' ? `/cs/projects/${project.slug}` : `/projects/${project.slug}`}
              class="inline-flex items-center text-sm font-medium text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300 transition-colors"
              aria-label={`${t.projects.viewDetails}: ${project.title}`}
            >
              {t.projects.viewDetails}
              <svg class="w-4 h-4 ml-1 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          </div>
        </article>
      ))}
    </div>

    <!-- View All Link -->
    <div class="text-center mt-12">
      <a
        href={lang === 'cs' ? '/cs/projects' : '/projects'}
        class="btn-secondary"
      >
        {t.common.viewAll}
        <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
        </svg>
      </a>
    </div>
  </div>
</section>

<script>
  // Category filter functionality
  const categoryButtons = document.querySelectorAll('.category-btn');
  const projectCards = document.querySelectorAll('[data-category]');

  // Set active button style
  function setActiveButton(activeBtn: Element) {
    categoryButtons.forEach((btn) => {
      btn.classList.remove('bg-primary-600', 'text-white');
      btn.classList.add('bg-gray-200', 'dark:bg-dark-700', 'text-gray-700', 'dark:text-gray-300');
      btn.setAttribute('aria-pressed', 'false');
    });
    activeBtn.classList.remove('bg-gray-200', 'dark:bg-dark-700', 'text-gray-700', 'dark:text-gray-300');
    activeBtn.classList.add('bg-primary-600', 'text-white');
    activeBtn.setAttribute('aria-pressed', 'true');
  }

  // Initialize with 'all' button active
  const allBtn = document.querySelector('[data-category="all"]');
  if (allBtn) {
    setActiveButton(allBtn);
  }

  categoryButtons.forEach((button) => {
    button.addEventListener('click', () => {
      const category = button.getAttribute('data-category');
      setActiveButton(button);

      projectCards.forEach((card) => {
        const cardCategory = card.getAttribute('data-category');
        const htmlCard = card as HTMLElement;

        if (category === 'all' || cardCategory === category) {
          htmlCard.style.display = 'block';
          htmlCard.classList.add('animate-fade-in');
        } else {
          htmlCard.style.display = 'none';
        }
      });
    });
  });
</script>

<style>
  .category-btn:first-child {
    @apply bg-primary-600 text-white;
  }
</style>
