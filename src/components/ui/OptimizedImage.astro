---
/**
 * OptimizedImage - Performance-optimized image component
 *
 * Features:
 * - Uses Astro's optimized image service (Sharp) for local images
 * - Fallback to standard img tag for remote images
 * - Explicit width/height to prevent CLS
 * - Lazy loading for below-fold images
 * - Loading="eager" for LCP candidates (above fold)
 * - Async decoding for faster page rendering
 * - Proper alt text for accessibility
 *
 * Usage:
 * <OptimizedImage
 *   src={imagePath}
 *   alt="Description"
 *   width={800}
 *   height={600}
 *   loading="eager" | "lazy"  // Default: "lazy"
 *   class="custom-class"
 * />
 */

import type { ImageMetadata } from 'astro';
import { Image } from 'astro:assets';

interface Props {
  src: ImageMetadata | string;
  alt: string;
  width?: number;
  height?: number;
  loading?: 'eager' | 'lazy';
  decoding?: 'async' | 'auto' | 'sync';
  class?: string;
  id?: string;
  sizes?: string;
  preload?: boolean;
}

const {
  src,
  alt,
  width,
  height,
  loading = 'lazy',
  decoding = 'async',
  class: className = '',
  id = '',
  sizes = '(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw',
  preload = false,
} = Astro.props;

// Check if local or remote
const isRemote = typeof src === 'string';
const resolvedWidth = width || 800;
const resolvedHeight = height || 600;

// Add preload link for LCP candidates
const shouldPreload = preload || loading === 'eager';
---

{
  shouldPreload && (
    <link
      rel="preload"
      as="image"
      href={isRemote ? src : (src as ImageMetadata).src}
      media={`(max-width: ${resolvedWidth}px)`}
    />
  )
}

{
  isRemote ? (
    <img
      src={src as string}
      alt={alt}
      width={resolvedWidth}
      height={resolvedHeight}
      loading={loading}
      decoding={decoding}
      class={className}
      sizes={sizes}
      id={id}
    />
  ) : (
    <Image
      src={src as ImageMetadata}
      alt={alt}
      width={resolvedWidth}
      height={resolvedHeight}
      loading={loading}
      decoding={decoding}
      class={className}
      sizes={sizes}
      id={id}
    />
  )
}
