---
/**
 * OptimizedImage - Performance-optimized image component
 * 
 * Features:
 * - Uses Astro's optimized image service (Sharp)
 * - Generates WebP/AVIF formats automatically
 * - Explicit width/height to prevent CLS
 * - Lazy loading for below-fold images
 * - Loading="eager" for LCP candidates (above fold)
 * - Async decoding for faster page rendering
 * - Proper alt text for accessibility
 * 
 * Usage:
 * <OptimizedImage 
 *   src={imagePath} 
 *   alt="Description" 
 *   width={800} 
 *   height={600}
 *   loading="eager" | "lazy"  // Default: "lazy"
 *   class="custom-class"
 * />
 */

import type { ImageMetadata } from 'astro';
import { Image } from 'astro:assets';

interface Props {
  src: ImageMetadata | string;
  alt: string;
  width?: number;
  height?: number;
  loading?: 'eager' | 'lazy';
  decoding?: 'async' | 'auto' | 'sync';
  class?: string;
  id?: string;
  sizes?: string;
  preload?: boolean;
}

const {
  src,
  alt,
  width,
  height,
  loading = 'lazy',
  decoding = 'async',
  class: className = '',
  id = '',
  sizes = '(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw',
  preload = false
} = Astro.props;

// Generate srcset for responsive images
const srcset = width
  ? `${width}w`
  : '';

// Handle remote images differently
const isRemote = typeof src === 'string';
const imgProps = {
  src: isRemote ? src : (src as ImageMetadata),
  alt,
  width: width || 800,
  height: height || 600,
  loading,
  decoding,
  class: className,
  sizes,
  id
};

// Add preload link for LCP candidates
const shouldPreload = preload || loading === 'eager';
---

{shouldPreload && (
  <link 
    rel="preload" 
    as="image" 
    href={isRemote ? src : (src as ImageMetadata).src}
    {...(width && { media: `(max-width: ${width}px)` })}
  />
)}

<Image
  {...imgProps}
/>
