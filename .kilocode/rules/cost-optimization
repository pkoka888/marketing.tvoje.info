# AGENTS.md
# Cost Optimization Rule — Canonical Version
# All other agent dirs reference or mirror this file.

## Budget (STRICT)
- **T1 Free (Primary)**: Unlimited (Kilo/grok-code-fast-1:optimized:free, OpenCode/big-pickle, OpenRouter/minimax)
- **T2 Complex (Secondary)**: Gemini 2.5 Pro (Free Tier - 1M TPD)
- **T3 Architect (Orchestrator)**: Antigravity / Gemini 2.5 Pro (Free Quota)
- **T4 Paid (Last Resort)**: $20/month max cap (OpenAI/Groq)

## Routing Matrix

| Task Type | Agent | Model | Tier |
| --------- | ----- | ----- | ---- |
| Bulk coding | Kilo CLI | `x-ai/grok-code-fast-1:optimized:free` | T1 Free |
| Routine fixes | OpenCode | `big-pickle` | T1 Free |
| Research | Gemini CLI | `gemini-2.5-flash` | T2 Free |
| Planning | Cline | `minimax-m2.1:free` | T1 Free |
| **Fallback** | Groq | `llama-3.3-70b` | **T4 Paid** |

## Resource Conservation (IMPORTANT)
- **NEVER use Gemini for internal code searches** (codesearch, grep, file search)
- Use `x-ai/grok-code-fast-1:optimized:free` for all internal search operations
- Reserve Gemini 2.5 Pro/Flash for: external web research, complex architecture, high-context reasoning

## Kill-Switch

If approaching $20/month on any provider:
1. Stop using paid models immediately
2. Switch all tasks to free alternatives
3. Log in `vscodeportable/research/cost-alerts.md`

## Groq (T4 — Last Resort, Pay-Per-Token)

- **Status**: Last resort ONLY — never primary, never default
- **Cost**: $0.59/$0.79 per 1M tokens (llama-3.3-70b), $0.05/$0.08 (llama-3.1-8b)
- **Rate limits**: 30 RPM, 1K RPD, 100K TPD (llama-3.3-70b)
- **Use when**: T1 free (grok-code-fast-1:optimized:free + big-pickle) + T2 (Gemini flash) + T3 fail
- **DO NOT use for**: Bulk coding, docs, testing — use T1 free instead

## References

- `.agents/rules/cost-optimization.md` (BMAD Squad mirror)
- `.clinerules/skills/cost-optimization.md` (Cline mirror)
- `.gemini/rules/cost-optimization.md` (Gemini-CLI mirror)
